import numpy as np
from typing import Union
#导入制图
from matplotlib import pyplot as plt
def calculate_ln_v_slope_with_full_time_scaling(
    t_matrix: np.ndarray, 
    dt_matrix: np.ndarray, 
    l_scalar: float
) -> np.ndarray:
    """
    计算基于 (t * 10^-3) - ln(v) 数据的线性回归斜率。
    同时对 t 和 dt 矩阵进行 10^-3 的缩放。
    
    参数:
    t_matrix (np.ndarray): 原始时间 t (x轴)。
    dt_matrix (np.ndarray): 原始时间间隔 dt (用于计算 v)。
    l_scalar (float): 长度/位移变量 (标量)。
    
    返回:
    np.ndarray: 包含所有计算得到的斜率的一维数组。
    """
    
    # 1. 检查输入矩阵的形状是否匹配
    if t_matrix.shape != dt_matrix.shape:
        raise ValueError(
            f"输入矩阵的形状必须匹配。t_matrix 形状: {t_matrix.shape}, "
            f"dt_matrix 形状: {dt_matrix.shape}"
        )
    
    # **核心修改 1**: 对整个矩阵进行尺度变换 (t_new = t * 10^-3)
    t_scaled = t_matrix * 1e-3
    
    # **核心修改 2**: 对整个 dt 矩阵进行尺度变换 (dt_new = dt * 10^-3)
    dt_scaled = dt_matrix * 1e-3
    
    num_groups = t_matrix.shape[0]
    slopes = np.full(num_groups, np.nan, dtype=float)
    
    # 2. 遍历每一行 (每一组数据)
    for i in range(num_groups):
        t = t_scaled[i, :]   # 缩放后的 x 轴数据
        dt = dt_scaled[i, :] # 缩放后的 dt 数据
        
        try:
            # 2.1 检查 dt 或 l 是否会导致非正速度
            if l_scalar <= 0:
                 raise ValueError("长度 l_scalar 必须大于 0。")
            if np.any(dt <= 0):
                print(f"警告: 第 {i+1} 组缩放后的 dt 数组中包含非正值 (<= 0)，无法计算速度和对数。")
                continue
                
            # 2.2 计算速度数组 V = L / DT
            # 注意：如果 L 和 DT 的单位统一，V 的单位是 L/T 的单位（例如 m/s）
            v = l_scalar / dt
            
            # 2.3 计算 ln(v) 作为 Y 轴数据
            ln_v = np.log(v)
            plt.plot(t,ln_v,label=f'第{i+1}组数据')
            plt.show()
            # 2.4 执行线性回归 (最小二乘法拟合)
            # x=t (已缩放), y=ln_v, deg=1
            coefficients = np.polyfit(t, ln_v, 1)
            slope = coefficients[0]
            
            # 存储斜率
            slopes[i] = slope
            
        except Exception as e:
            # 处理其他拟合失败的错误
            print(f"拟合第 {i+1} 组数据时发生错误: {e}")

    return slopes

# --- 示例用法 ---

l_val = 0.01 # 长度/位移 (常量)

# 示例数据：假设原始单位都是毫秒 (ms) 或微秒 (µs)，现在需要转换为秒 (s)
dt_matrix_data = np.array([
    # 第1组实验：时间
    [76.13, 80.14, 83.10, 85.16, 87.66, 89.62, 91.12, 92.21],
    # 第2组实验：时间
    [44.63, 45.22, 45.73, 47.12, 48.09, 48.12, 48.61, 49.21],
    # 第3组实验：时间
    [42.13, 42.68, 43.20, 44.70, 45.67, 46.70, 47.20, 49.21],
    # 第4组实验：时间
    [33.11, 31.70, 32.12, 32.70, 33.17, 33.62, 34.24, 35.12],
    # 第5组实验：时间
    [37.09, 37.73, 38.52, 40.12, 41.14, 42.12, 43.23, 44.74],
    # 第6组实验：时间
    [37.63, 38.71, 40.21, 41.62, 43.20, 44.00, 45.74, 47.22],
    # 第7组实验：时间
    [23.10, 23.24, 23.62, 24.66, 25.12, 26.22, 26.74, 26.62]
])

# 整理为时刻数据数组 (t_matrix)：结构与时间数组对应
t_matrix_data = np.array([
    # 第1组实验：时刻
    [0, 185, 1843, 3224, 4440, 5207, 6434, 7218],
    # 第2组实验：时刻
    [0, 451, 1047, 1808, 2459, 2841, 3545, 4234],
    # 第3组实验：时刻
    [0, 4026, 990, 1713, 2327, 2747, 3841, 4066],  # 注意：第3组第2列时刻原文为“4026”
    # 第4组实验：时刻
    [0, 314, 730, 1261, 1710, 2014, 2475, 2965],
    # 第5组实验：时刻
    [0, 376, 827, 1524, 2077, 2456, 3033, 3645],   # 注意：第5组第2列时刻原文为“374”
    # 第6组实验：时刻
    [0, 384, 899, 1568, 2144, 2542, 3150, 3806],   # 注意：第6组第8列时刻原文为“3806”
    # 第7组实验：时刻
    [0, 233, 541, 937, 1272, 1591, 1848, 2219]
])


# 时间数组（dt_matrix：7组实验 × 8个磁铁）
dt_matrix_field = np.array([
    # 第1组
    [48.65, 49.67, 50.62, 51.24, 52.62, 53.21, 54.21, 54.62],
    # 第2组
    [47.13, 48.70, 49.24, 50.59, 51.62, 51.73, 52.66, 52.60],
    # 第3组
    [39.11, 39.73, 40.68, 41.62, 42.58, 43.21, 44.12, 44.70],
    # 第4组
    [44.13, 45.70, 46.62, 47.51, 49.12, 50.24, 52.19, 53.22],
    # 第5组
    [59.63, 62.62, 65.62, 68.62, 72.64, 75.01, 79.18, 83.62],
    # 第6组
    [65.63, 69.70, 74.21, 79.20, 85.12, 89.74, 94.62, 101.7],
    # 第7组
    [31.63, 32.18, 33.12, 34.09, 34.74, 35.20, 36.70, 37.71]
])

# 时刻数组（t_matrix：与时间数组一一对应）
t_matrix_field = np.array([
    # 第1组
    [0, 445, 1150, 1984, 2689, 3169, 3894, 4661],
    # 第2组
    [0, 482, 1122, 1939, 2631, 3102, 3807, 4548],
    # 第3组
    [0, 346, 923, 1596, 2166, 2555, 3144, 3769],
    # 第4组
    [0, 451, 1052, 1824, 2481, 2933, 3627, 4369],
    # 第5组
    [0, 614, 1462, 2552, 3512, 4183, 5225, 6363],
    # 第6组
    [0, 680, 1618, 2877, 3993, 4787, 6027, 7392],
    # 第7组
    [0, 321, 748, 1296, 1764, 2084, 2572, 3097]
])

import numpy as np

# 时间数组（dt_matrix：7组实验 × 8个磁铁）
dt_matrix_length = np.array([
    # 第1组
    [45.73, 47.70, 47.68, 49.12, 50.23, 50.70, 51.62, 52.01],
    # 第2组
    [35.63, 36.19, 36.12, 36.61, 36.70, 37.21, 37.74, 38.23],
    # 第3组
    [36.71, 37.14, 37.68, 37.54, 38.21, 38.25, 38.66, 39.12],
    # 第4组
    [35.68, 36.66, 36.72, 37.12, 37.70, 37.66, 38.17, 38.72],
    # 第5组
    [47.23, 48.61, 49.01, 50.14, 51.70, 52.62, 54.12, 53.23],
    # 第6组
    [36.61, 36.73, 37.12, 37.62, 38.16, 38.62, 39.12, 39.24],
    # 第7组
    [52.63, 54.17, 55.12, 57.12, 59.24, 60.23, 61.71, 63.70]
])

# 时刻数组（t_matrix：与时间数组一一对应）
t_matrix_length = np.array([
    # 第1组
    [0, 467, 1086, 1880, 2554, 3049, 3706, 4437],
    # 第2组
    [0, 359, 830, 1424, 1922, 2254, 2766, 3303],
    # 第3组
    [0, 322, 862, 1480, 1997, 2346, 2868, 3417],
    # 第4组
    [0, 363, 840, 1446, 1954, 2290, 2812, 3356],
    # 第5组
    [0, 481, 1120, 1937, 2628, 3101, 3821, 4592],
    # 第6组
    [0, 369, 823, 1468, 1985, 2335, 2861, 3416],
    # 第7组
    [0, 536, 1249, 2168, 2958, 3501, 4325, 5208]
])

t = np.array([
[0, 542, 1289, 2299, 3095, 3732, 4683, 5658]

])
dt = np.array([

[54.03, 54.54, 57.19, 62.04, 64.37, 67.34, 72.21, 75.51]
])
#27 332  437  476
t_w = np.array([
[0, 1099, 2655, 4547, 6385, 7596, 9349, 11341],
[0, 784, 1834, 3122, 4322, 5146, 6393, 7782],
[0, 705, 1692, 2932, 3957, 4740, 5940, 7299],
[0, 443, 1056, 1795, 2464, 3010, 3608, 4457],
[0, 551, 1346, 2319, 3185, 3717, 4619, 5757]
])
dt_w = np.array([
[110.24, 111.37, 117.8, 125.72, 131.12, 134.41, 143.21, 146.86],
[74.86, 79.58, 82.19, 83.08, 87.92, 90.19, 93.65, 99.24],
[68.11, 72.45, 74.73, 77.81, 81.52, 82.78, 88.22, 92.21],
[43.47, 45.76, 46.9, 47.85, 49.38, 50.09, 52.41, 53.48],
[55.93, 57.06, 58.32, 61.47, 62.77, 66.01, 69.52, 73.17]
])

# 打印验证
print("纵向长度实验 - 时间数组形状:", dt_matrix_length.shape)
print("纵向长度实验 - 时刻数组形状:", t_matrix_length.shape)

# 调用函数计算所有斜率
calculated_slopes_matrix = calculate_ln_v_slope_with_full_time_scaling(
    t_w
    , dt_w, l_val
)

print("\n--- 结果 ---")
for i, slope in enumerate(calculated_slopes_matrix):
    print(f"第 {i+1} 组 斜率: {slope:.4f}")